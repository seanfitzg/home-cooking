version: "3.4"

services:
  pgsql:
    image: postgres:latest
    environment:
      POSTGRES_DB: homecooking
      POSTGRES_USER: dbuser
      POSTGRES_PASSWORD: Password1!
    volumes:
      - ./sql/data:/var/lib/postgresql/data
      - ./sql/scripts:/docker-entrypoint-initdb.d/
    restart: always
    ports:
      - "5432:5432"

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"

  home-cooking-app:
    depends_on:
      - pgsql
    restart: always
    image: ${DOCKER_REGISTRY-}home-cooking-app:dev
    build:
      context: .
      dockerfile: ./HomeCooking.Api/Dockerfile
    ports:
      - "5000:80"
      - "3500:3500" # expose the dapr port as well.
    environment:
      - IP=localhost # use 0.0.0.0 for heroku
      - PORT=80
      - DB_CONNECTION_STRING=Host=pgsql;Port=5432;Database=homecooking;Username=homecooking;Password=homecooking

  home-cooking-app-dapr:
    image: "daprio/daprd:latest"
    command:
      [
        "./daprd",
        "-app-id",
        "home-cooking-app",
        "-app-port",
        "80",
        "-components-path",
        "/dapr",
      ]
    volumes:
      - "./dapr/:/dapr"
    depends_on:
      - home-cooking-app
      - pgsql
    network_mode: "service:home-cooking-app"

  logging-app:
    image: ${DOCKER_REGISTRY-}logging-app:dev
    build:
      context: .
      dockerfile: ./HomeCooking.Logging/Dockerfile
    ports:
      - "5001:80"

  logging-app-dapr:
    image: "daprio/daprd:latest"
    command:
      [
        "./daprd",
        "-app-id",
        "logging-app",
        "-app-port",
        "80",
        "-components-path",
        "/dapr",
      ]
    volumes:
      - "./dapr/:/dapr"
    depends_on:
      - logging-app
      - pgsql
    network_mode: "service:logging-app"

  home-cooking-queries:
    image: ${DOCKER_REGISTRY-}home-cooking-queries:dev
    build:
      context: .
      dockerfile: ./HomeCooking.Queries/Dockerfile
    ports:
      - "5004:80"
      - "3502:3502" # expose the dapr port as well.

  home-cooking-queries-dapr:
    image: "daprio/daprd:latest"
    command:
      [
        "./daprd",
        "-app-id",
        "home-cooking-queries",
        "-app-port",
        "80",
        "-dapr-http-port",
        "3502",
        "-components-path",
        "/dapr",
      ]
    volumes:
      - "./dapr/:/dapr"
    depends_on:
      - home-cooking-queries
      - pgsql
    network_mode: "service:home-cooking-queries"
