version: '3.4'

services:

  mysql:
    platform: linux/x86_64 # require for m1.
    image: mysql:latest
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 1
      MYSQL_DATABASE: homecooking
      MYSQL_USER: dbuser
      MYSQL_PASSWORD: Password1!
    volumes:
      - ./mysql-data:/var/lib/mysql/
    restart: always
    ports:
      - "3306:3306"
      
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
  
  homecooking-app:
    depends_on:
      - mysql
    restart: always
    image: ${DOCKER_REGISTRY-}homecooking-app:dev
    build:
      context: .
      dockerfile: ./HomeCooking.Api/Dockerfile
    ports:
      - "5000:80"
    environment:
      - USE_MY_SQL=true
      - DATA_SERVER=mysql
  
  homecooking-app-dapr:
    image: "daprio/daprd:latest"
    command: [ "./daprd", 
                "-app-id", "homecooking-app", 
                "-app-port", "80",
                "-components-path", "/dapr"       
              ]
    volumes:
      - "./dapr/:/dapr"  
    depends_on:
      - homecooking-app
    network_mode: "service:homecooking-app"

  logging-app:
    image: ${DOCKER_REGISTRY-}logging-app:dev
    build:
      context: .
      dockerfile: ./HomeCooking.Logging/Dockerfile
    ports:
      - "5001:80"

  logging-app-dapr:
    image: "daprio/daprd:latest"
    command: [ "./daprd",
                "-app-id", "logging-app",
                "-app-port", "80",
                "-components-path", "/dapr"
    ]
    volumes:
      - "./dapr/:/dapr"
    depends_on:
      - logging-app
    network_mode: "service:logging-app"

  home-cooking-queries:
    image: ${DOCKER_REGISTRY-}home-cooking-queries:dev
    build:
      context: .
      dockerfile: ./HomeCooking.Queries/Dockerfile
    ports:
      - "5004:80"
      - "3502:3502"  # expose the dapr port as well.

  home-cooking-queries-dapr:
    image: "daprio/daprd:latest"
    command: [ "./daprd",
               "-app-id", "home-cooking-queries",
               "-app-port", "80",
               "-dapr-http-port", "3502",
               "-components-path", "/dapr"
    ]
    volumes:
      - "./dapr/:/dapr"
    depends_on:
      - home-cooking-queries
    network_mode: "service:home-cooking-queries"
